<div class="pollution-form-container">
  <div class="form-card">
    <div class="form-header">
      <h2>{{ isEditMode() ? '√âdition rapide' : 'Nouvelle D√©claration' }}</h2>
      <p class="subtitle">
        {{ isEditMode() ? 'Modifier les informations de la pollution' : 'D√©clarer une Pollution' }}
      </p>
    </div>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Titre -->
      <div class="form-group">
        <label for="titre">Titre de la pollution *</label>
        <input
          type="text"
          id="titre"
          formControlName="titre"
          placeholder="Ex: D√©versement d'huile pr√®s du ruisseau"
          class="form-control"
          [class.error]="hasError('titre')"
        />
        @if (hasError('titre')) {
          <div class="error-message">
            @if (form.get('titre')?.errors?.['required']) {
              Le titre est requis
            } @else if (form.get('titre')?.errors?.['minlength']) {
              Le titre doit contenir au moins 3 caract√®res
            }
          </div>
        }
      </div>

      <!-- Type -->
      <div class="form-group">
        <label for="type">Type de pollution *</label>
        <select id="type" formControlName="type" class="form-control" [class.error]="hasError('type')">
          <option value="">-- S√©lectionnez un type --</option>
          @for (t of types; track t) {
            <option [value]="t">{{ t }}</option>
          }
        </select>
        @if (hasError('type')) {
          <div class="error-message">Le type est requis</div>
        }
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description">Description *</label>
        <textarea
          id="description"
          formControlName="description"
          rows="4"
          placeholder="D√©crivez la pollution observ√©e en d√©tail..."
          class="form-control"
          [class.error]="hasError('description')"
        ></textarea>
        @if (hasError('description')) {
          <div class="error-message">
            @if (form.get('description')?.errors?.['required']) {
              La description est requise
            } @else if (form.get('description')?.errors?.['minlength']) {
              La description doit contenir au moins 10 caract√®res
            }
          </div>
        }
      </div>

      <!-- Date -->
      <div class="form-group">
        <label for="dateObservation">Date de l'observation *</label>
        <input
          type="date"
          id="dateObservation"
          formControlName="dateObservation"
          class="form-control"
          [class.error]="hasError('dateObservation')"
        />
        @if (hasError('dateObservation')) {
          <div class="error-message">La date est requise</div>
        }
      </div>

      <!-- Niveau -->
      <div class="form-group">
        <label for="niveau">Niveau de gravit√© *</label>
        <select id="niveau" formControlName="niveau" class="form-control" [class.error]="hasError('niveau')">
          <option value="">-- S√©lectionnez un niveau --</option>
          @for (n of niveaux; track n) {
            <option [value]="n">{{ n }}</option>
          }
        </select>
        @if (hasError('niveau')) {
          <div class="error-message">Le niveau est requis</div>
        }
      </div>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- LOCATION SECTION                                     -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <fieldset class="location-section">
        <legend>Localisation *</legend>

        <!-- Location Type Toggle -->
        <div class="toggle-group">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="locationType() === 'address'"
            (click)="setLocationType('address')"
          >
            üìç Adresse
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="locationType() === 'gps'"
            (click)="setLocationType('gps')"
          >
            üõ∞Ô∏è Coordonn√©es GPS
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="locationType() === 'both'"
            (click)="setLocationType('both')"
          >
            üìçüõ∞Ô∏è Les deux
          </button>
        </div>

        <!-- Address Field -->
        @if (showAddressField()) {
          <div class="form-group">
            <label for="adresse">Adresse</label>
            <input
              type="text"
              id="adresse"
              formControlName="adresse"
              placeholder="Ex: 12 rue de la Rivi√®re, 75001 Paris"
              class="form-control"
            />
          </div>
        }

        <!-- GPS Coordinates -->
        @if (showGpsFields()) {
          <div class="form-row">
            <div class="form-group">
              <label for="latitude">Latitude</label>
              <input
                type="number"
                id="latitude"
                formControlName="latitude"
                step="0.000001"
                placeholder="48.8566"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="longitude">Longitude</label>
              <input
                type="number"
                id="longitude"
                formControlName="longitude"
                step="0.000001"
                placeholder="2.3522"
                class="form-control"
              />
            </div>
          </div>

          <button type="button" class="btn btn-secondary btn-small" (click)="useCurrentLocation()">
            üì± Utiliser ma position actuelle
          </button>
        }

        <!-- Location Validation Error -->
        @if (hasFormError('locationRequired')) {
          <div class="error-message location-error">Veuillez fournir une adresse ou des coordonn√©es GPS</div>
        }
      </fieldset>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- PHOTO SECTION                                        -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <fieldset class="photo-section">
        <legend>Photo (optionnel)</legend>

        <!-- Photo Source Toggle -->
        <div class="toggle-group">
          <button
            type="button"
            class="toggle-btn"
            [class.active]="photoSource() === 'url'"
            (click)="setPhotoSource('url')"
          >
            üîó URL
          </button>
          <button
            type="button"
            class="toggle-btn"
            [class.active]="photoSource() === 'upload'"
            (click)="setPhotoSource('upload')"
          >
            üì§ T√©l√©charger
          </button>
        </div>

        <!-- URL Input -->
        @if (showPhotoUrlInput()) {
          <div class="form-group">
            <input
              type="url"
              id="photoUrl"
              formControlName="photoUrl"
              placeholder="https://example.com/photo.jpg"
              class="form-control"
            />
            <small class="helper-text">Entrez l'URL d'une image existante</small>
          </div>
        }

        <!-- File Upload -->
        @if (showPhotoUpload()) {
          <div
            class="form-group upload-zone"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
          >
            @if (!uploadedPhotoUrl()) {
              <label
                for="fileInput"
                class="upload-label"
                [class.uploading]="isUploading()"
                [class.dragging]="isDragging()"
              >
                @if (isUploading()) {
                  <span class="spinner"></span>
                  <span>T√©l√©chargement en cours...</span>
                } @else {
                  <span class="upload-icon">üì∑</span>
                  <span>Cliquez ou glissez une image ici</span>
                  <small>JPG, PNG, GIF - Max 5 Mo</small>
                }
              </label>
              <input
                type="file"
                id="fileInput"
                accept="image/*"
                (change)="onFileSelected($event)"
                [disabled]="isUploading()"
                class="file-input"
              />
            } @else {
              <div class="uploaded-preview">
                <span class="success-icon">‚úÖ</span>
                <span>Image t√©l√©charg√©e</span>
                <button type="button" class="btn btn-danger btn-small" (click)="removeUploadedPhoto()">
                  Supprimer
                </button>
              </div>
            }
          </div>
        }

        <!-- Image Preview -->
        @if (isValidImageUrl(form.get('photoUrl')?.value) && !photoPreviewError()) {
          <div class="image-preview">
            <img
              [src]="getPreviewUrl(form.get('photoUrl')?.value)"
              alt="Aper√ßu de la photo"
              (error)="onImageError()"
              (load)="onImageLoad()"
            />
          </div>
        }

        @if (photoPreviewError()) {
          <div class="preview-error">‚ö†Ô∏è Impossible de charger l'aper√ßu de l'image</div>
        }
      </fieldset>

      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <!-- FORM ACTIONS                                         -->
      <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="onCancel()">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="form.invalid">
          {{ isEditMode() ? 'Mettre √† jour' : 'Cr√©er la d√©claration' }}
        </button>
      </div>
    </form>
  </div>
</div>
